-- / Roblox Services /
local ContextActionService = game:GetService("ContextActionService")
local Debris = game:GetService("Debris")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
-- / Game Folders /
local Players  = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
-- / Player /
local Player = Players.LocalPlayer
local Mouse = Player:GetMouse()
local Camera = workspace.CurrentCamera

-- / Local Settings

-- / Functions
function Raycast(origin,direction,ignores,test) -- 18
	local RaycastParam = RaycastParams.new()
	RaycastParam.IgnoreWater = true
	RaycastParam.FilterType = Enum.RaycastFilterType.Exclude
	RaycastParam.FilterDescendantsInstances = ignores or {}

	local results = game:GetService("Workspace"):Raycast(origin,direction,RaycastParam)

	return results
end

function GetChar(send,check) -- 7,3
	if NilCheck(send) then return end
	if send:IsA("Player") then
		send = send.Character
	end
	if send then
		local Humanoid = send:FindFirstChildOfClass("Humanoid") or send.Parent:FindFirstChildOfClass("Humanoid")
		if Humanoid then
			local Character = Humanoid.Parent
			local humPart = Character:FindFirstChild("HumanoidRootPart")
			local Animator = Humanoid:FindFirstChildOfClass("Animator")
			if humPart and Animator then
				if not check or Humanoid.Health > 0 then
					return Character,Humanoid,humPart,Animator
				end
			end
		end
	end
end

function GetTool(send,check) -- 7,20
	local Character = GetChar(send,check)
	if Character then
		local Tool = Character:FindFirstChildOfClass("Tool")
		if Tool then
			return Tool
		end
	end
end

function Destroy(instance) -- 4
	if not NilCheck(instance) then
		instance:Destroy()
	end
end

function Lerp(min,max,dist) -- 12
	return min+(max-min)*dist
end

function NilCheck(instance) -- 14
	if not instance or typeof(instance) ~= "Instance" or not instance.Parent then
		return true
	else
		return false
	end
end

function GetAllChars()
	local chars = {}
	local function FindChars(folder)
		for _,v in pairs(folder:GetChildren()) do
			local char = GetChar(v)
			if char and not table.find(chars,char) then
				table.insert(chars,char)
			end
		end
	end
	FindChars(workspace)
	for _,v in pairs(workspace:GetChildren()) do
		if v:IsA("Folder") then
			FindChars(v)
		end
	end
	
	return chars
end

function GetClosestToMouse(range,onlyPlayer)
	local target = nil
	local minDist = range
	local chars = nil
	if onlyPlayer then
		for _,player in pairs(Players:GetPlayers()) do
			local char = GetChar(Player)
			if char then
				table.insert(chars,char)
			end
		end
	else
		chars = GetAllChars()
	end
	if not chars or not next(chars) then return end
	
	for _,char in pairs(chars) do
		if char.Name ~= Player.Name then
			local humPart = char:FindFirstChild("HumanoidRootPart")
			local screenpoint,visible = Camera:WorldToScreenPoint(humPart.Position)
			local distance = (Vector2.new(Mouse.X,Mouse.Y)-Vector2.new(screenpoint.X,screenpoint.Y)).Magnitude
			if visible and distance <= minDist then
				target = char
				minDist = distance
			end
		end
	end
	
	return target
end

function AddCharm(part,color,transparency)
	if NilCheck(part) then return end
	local function CharmPart(p)
		local Charm = p:FindFirstChild("Charm") or Instance.new("BoxHandleAdornment")
		Charm.Name = "Charm"
		Charm.Adornee = p
		Charm.AlwaysOnTop = true
		Charm.Color3 = color or Color3.fromRGB(255,255,255)
		Charm.Transparency = transparency or 0.3
		Charm.Size = p.Size
		Charm.Visible = true
		Charm.ZIndex = 1
		Charm.Parent = p
	end
	if part:IsA("Model") then
		for _,v in pairs(part:GetChildren()) do
			if v:IsA("BasePart") then
				CharmPart(v)
			end
		end
	else
		CharmPart(part)
	end
	
end

RunService.PreRender:Connect(function(step)
	Camera.FieldOfView = 90
	Player.CameraMinZoomDistance = 0.5
	Player.CameraMaxZoomDistance = 50
	Player.CameraMode = Enum.CameraMode.Classic
	
	local chars = GetAllChars()
	for _,char in pairs(chars) do
		local player = Players:GetPlayerFromCharacter(char)
		if player then
			AddCharm(char,Color3.fromRGB(0,0,255))
		else
			AddCharm(char,Color3.fromRGB(255,0,0))
		end
	end
end)
