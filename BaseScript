-- / Roblox Services /
local ContextActionService = game:GetService("ContextActionService")
local Debris = game:GetService("Debris")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
-- / Game Folders /
local Players  = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
-- / Player /
local Player = Players.LocalPlayer
local Mouse = Player:GetMouse()
local Camera = workspace.CurrentCamera

-- / Local Settings
local gui = Instance.new("ScreenGui",Player.PlayerGui)

-- / Local Variables
aimbot = false
epitaph = 0.234

-- / Functions
function Raycast(origin,direction,ignores,test) -- 18
	local RaycastParam = RaycastParams.new()
	RaycastParam.IgnoreWater = true
	RaycastParam.FilterType = Enum.RaycastFilterType.Exclude
	RaycastParam.FilterDescendantsInstances = ignores or {}

	local results = game:GetService("Workspace"):Raycast(origin,direction,RaycastParam)

	return results
end

function GetChar(send,check) -- 7,3
	if NilCheck(send) then return end
	if send:IsA("Player") then
		send = send.Character
	end
	if send then
		local Humanoid = send:FindFirstChildOfClass("Humanoid") or send.Parent:FindFirstChildOfClass("Humanoid")
		if Humanoid then
			local Character = Humanoid.Parent
			local humPart = Character:FindFirstChild("HumanoidRootPart")
			local Animator = Humanoid:FindFirstChildOfClass("Animator")
			if humPart and Animator then
				if not check or Humanoid.Health > 0 then
					return Character,Humanoid,humPart,Animator
				end
			end
		end
	end
end

function GetTool(send,check) -- 7,20
	local Character = GetChar(send,check)
	if Character then
		local Tool = Character:FindFirstChildOfClass("Tool")
		if Tool then
			return Tool
		end
	end
end

function Destroy(instance) -- 4
	if not NilCheck(instance) then
		instance:Destroy()
	end
end

function Lerp(min,max,dist) -- 12
	return min+(max-min)*dist
end

function NilCheck(instance) -- 14
	if not instance or typeof(instance) ~= "Instance" or not instance.Parent then
		return true
	else
		return false
	end
end

function GetAllChars()
	local chars = {}
	local function FindChars(folder)
		for _,v in pairs(folder:GetChildren()) do
			local char = GetChar(v)
			if char and not table.find(chars,char) then
				table.insert(chars,char)
			end
		end
	end
	FindChars(workspace)
	for _,v in pairs(workspace:GetChildren()) do
		if v:IsA("Folder") then
			FindChars(v)
		end
	end
	
	return chars
end

function GetClosestToMouse(range,onlyPlayer)
	local target = nil
	local minDist = range
	local chars = nil
	if onlyPlayer then
		for _,player in pairs(Players:GetPlayers()) do
			local char = GetChar(Player)
			if char then
				table.insert(chars,char)
			end
		end
	else
		chars = GetAllChars()
	end
	if not chars or not next(chars) then return end
	
	for _,char in pairs(chars) do
		if char.Name ~= Player.Name then
			local humPart = char:FindFirstChild("HumanoidRootPart")
			local screenpoint,visible = Camera:WorldToScreenPoint(humPart.Position)
			local distance = (Vector2.new(Mouse.X,Mouse.Y)-Vector2.new(screenpoint.X,screenpoint.Y)).Magnitude
			if visible and distance <= minDist then
				target = char
				minDist = distance
			end
		end
	end
	
	return target
end

function AddCharm(part,color,transparency)
	if NilCheck(part) then return end
	local function CharmPart(p)
		local Charm = p:FindFirstChild("Charm") or Instance.new("BoxHandleAdornment")
		Charm.Name = "Charm"
		Charm.Adornee = p
		Charm.AlwaysOnTop = true
		Charm.Color3 = color or Color3.fromRGB(255,255,255)
		Charm.Transparency = transparency or 0.3
		Charm.Size = p.Size
		Charm.Visible = true
		Charm.ZIndex = 1
		Charm.Parent = p
	end
	if part:IsA("Model") then
		for _,v in pairs(part:GetChildren()) do
			if v:IsA("BasePart") then
				CharmPart(v)
			end
		end
	else
		CharmPart(part)
	end
end

function CreateButton(text,pos,size,parent)
	local Button = Instance.new("TextButton")
	Button.BackgroundTransparency = 0.7
	Button.TextStrokeTransparency = 0.7
	Button.Text = text
	Button.Position = pos
	Button.Size = UDim2.new(0,size,0,size)
	Button.Parent = parent
	local Corner = Instance.new("UICorner",Button)
	Corner.CornerRadius = UDim.new(0,size/2)
	local Stroke = Instance.new("UIStroke",Button)
	Stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	Stroke.LineJoinMode = Enum.LineJoinMode.Round
	Stroke.Thickness = 3
	Stroke.Transparency = 0.3
	
	print(Button)
	return Button
end

local AimbotB = CreateButton("AimLock",UDim2.new(0.9,-50,0.4,-50),50,gui)
AimbotB.Activated:Connect(function(input)
	if aimbot then
		aimbot = false
	else
		aimbot = true
	end
end)

RunService.PreRender:Connect(function(step)
	local Character,Humanoid,humPart = GetChar(Player,true)
	
	if aimbot and Character then
		local target = GetClosestToMouse(100)
		print(target)
		if target then
			local Head,humPart = target:FindFirstChild("Head"), target:FindFirstChild("HumanoidRootPart")
			print(Head,humPart)
			if Head and humPart then
				local point = Head.CFrame+(humPart.Velocity*epitaph)
				Camera.CFrame = CFrame.lookAt(Camera.CFrame.Position,point.Position)
			end
		end
	end
	
	local chars = GetAllChars()
	for _,char in pairs(chars) do
		if char.Name ~= Player.Name then
			local player = Players:GetPlayerFromCharacter(char)
			if player then
				AddCharm(char,Color3.fromRGB(0,0,255))
			else
				AddCharm(char,Color3.fromRGB(255,0,0))
			end
		end
	end
end)
